name: Build & Push router image to Scaleway

on:
  push:
    branches: [ main ]    # 如果你主分支不是 main 改这里
  workflow_dispatch:       # 方便手动点一下跑

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 登录 Scaleway Container Registry
      - name: Login to Scaleway Container Registry
        uses: docker/login-action@v3
        with:
          username: nologin
          password: ${{ secrets.SCALEWAY_API_KEY }}
          registry: ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}

      # 构建镜像（会在 GitHub Runner 上用 BuildKit/buildx 构建）
      - name: Build Docker image
        run: |
          docker build . \
            -t ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/router:latest

      # 推送镜像到 ACR
      - name: Push Docker image
        run: |
          docker push ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/router:latest

